.PHONY: help dev build test clean docker-up docker-down logs swagger

# é»˜è®¤ç›®æ ‡
help:
	@echo "å¯ç”¨å‘½ä»¤:"
	@echo "  make dev         - å¯åŠ¨å¼€å‘æœåŠ¡å™¨"
	@echo "  make build       - æ„å»ºäºŒè¿›åˆ¶æ–‡ä»¶"
	@echo "  make test        - è¿è¡Œæµ‹è¯•"
	@echo "  make docker-up   - å¯åŠ¨ MySQL å®¹å™¨"
	@echo "  make docker-down - åœæ­¢ MySQL å®¹å™¨"
	@echo "  make logs        - æŸ¥çœ‹ MySQL æ—¥å¿—"
	@echo "  make swagger     - ç”Ÿæˆ Swagger æ–‡æ¡£"
	@echo "  make clean       - æ¸…ç†æ„å»ºäº§ç‰©"

# å¯åŠ¨ MySQL(å¦‚æœæ²¡è¿è¡Œ)
docker-up:
	@docker ps | grep -q mysql8 || \
    (docker start mysql8 2>/dev/null || \
    docker run -d --name mysql8 \
        -e MYSQL_ROOT_PASSWORD=pass \
        -e MYSQL_DATABASE=qingverse \
        -p 3306:3306 \
        -v mysql-data:/var/lib/mysql \
        mysql:8.0 \
        --character-set-server=utf8mb4 \
        --collation-server=utf8mb4_0900_ai_ci)
	@echo "â³ ç­‰å¾… MySQL å¯åŠ¨..."
	@sleep 3
	@docker exec -i mysql8 mysql -uroot -ppass -e "CREATE DATABASE IF NOT EXISTS qingverse CHARACTER SET utf8mb4 COLLATE utf8mb4_0900_ai_ci;" 2>/dev/null || true
	@docker exec -i mysql8 mysql -uroot -ppass qingverse < db/schema.sql 2>/dev/null || echo "âœ… è¡¨ç»“æ„å·²å­˜åœ¨"
	@echo "âœ… MySQL å°±ç»ª"

# ç”Ÿæˆ Swagger æ–‡æ¡£
swagger:
	@echo "ğŸ“– ç”Ÿæˆ API æ–‡æ¡£..."
	@swag init -g cmd/server/main.go -o docs
	@echo "âœ… æ–‡æ¡£å·²ç”Ÿæˆ,è®¿é—®: http://localhost:9000/swagger/index.html"

# å¼€å‘æ¨¡å¼(ä¾èµ– MySQL)
dev: docker-up swagger
	@echo "ğŸ”¥ å¯åŠ¨ API æœåŠ¡å™¨..."
	@go mod tidy
	@go run cmd/server/main.go

# æ„å»ºäºŒè¿›åˆ¶
build:
	@echo "ğŸ”¨ æ„å»ºä¸­..."
	@mkdir -p bin
	@go build -o bin/server cmd/server/main.go
	@echo "âœ… æ„å»ºå®Œæˆ: bin/server"

# è¿è¡Œæµ‹è¯•
test:
	@echo "ğŸ§ª è¿è¡Œæµ‹è¯•..."
	@go test -v ./...

# æŸ¥çœ‹ MySQL æ—¥å¿—
logs:
	@docker logs -f mysql8

# åœæ­¢ MySQL
docker-down:
	@docker stop mysql8 2>/dev/null || true
	@echo "âœ… MySQL å·²åœæ­¢"

# æ¸…ç†
clean:
	@rm -rf bin/ docs/
	@docker rm -f mysql8 2>/dev/null || true
	@echo "âœ… æ¸…ç†å®Œæˆ"